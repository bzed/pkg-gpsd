#!/usr/bin/env python
#
# gpsfake -- test harness for gpsd
#
# Simulates a GPS, playing back an NMEA logfile

import sys, os, time, signal, pty, getopt, tempfile, termios

(options, arguments) = getopt.getopt(sys.argv[1:], "c:hlno:s:")
cycle = 1
speed = 4800
spawn = True
linedump = False
doptions = ""
for (switch, val) in options:
    if (switch == '-c'):
        cycle = float(val)
    elif (switch == '-l'):
        linedump = True
    elif (switch == '-n'):
        spawn = False
    elif (switch == '-o'):
        doptions = val
    elif (switch == '-s'):
        speed = int(val)
    elif (switch == '-h'):
        sys.stderr.write("usage: gpsfake [-h] [-l] [-n] [-o options] [-s speed] [-c cycle] logfile\n")
        sys.exit(0)
logfile = arguments[0]

try:
    (master_fd, slave_fd) = pty.openpty()
except:
    sys.stderr.write("gpsfake: can't open pty.\n")
    sys.exit(1)
slave = os.ttyname(slave_fd)

spawncmd = "gpsd -N -P /tmp/gpsfake%d -p %s %s" % (os.getpid(),slave,doptions)
print spawncmd

if not spawn:
    sys.stderr.write("gpsfake: slave tty is %s\n" % slave)
elif os.system(spawncmd + " &"):
    sys.stderr.write("gpsfake: gpsd launch failed.\n")
    sys.exit(1)
else:
    sys.stderr.write("gpsfake: gpsd launch OK.\n")

    fp = open("/tmp/gpsfake%s" % os.getpid())
    pid = int(fp.read())
    fp.close()
    os.remove("/tmp/gpsfake%s" % os.getpid())

try:
    logfp = open(logfile, "r")
    logdata = logfp.read()
    logfp.close()
    while logdata[0] == "#":
        logdata = logdata[logdata.find('\n')+1:]
    if logdata[0] == '$':
        print "gpsfake: interpreting as NMEA"
        leader = '$';
        legend = "gpsfake: line %d"
    elif logdata[0] == 0xa0:
        print "gpsfake: interpreting as SiRF-II binary packets"
        leader = 0xa0
        legend = "gpsfake: packet %d"
    else:
        print "gpsfake: unknown log type, can't handle it!"
        logdata = None

    if logdata:
        lines = map(lambda x: leader+x, logdata.split(leader)[1:])
        print lines

        ttyfp = open(slave, "rw")
        raw = termios.tcgetattr(ttyfp.fileno())
        raw[0] = 0					# iflag
        raw[1] = termios.ONLCR				# oflag
        raw[2] &= ~(termios.PARENB | termios.CRTSCTS)	# cflag
        raw[2] |= (termios.CSIZE & termios.CS8)		# cflag
        raw[2] |= termios.CREAD | termios.CLOCAL	# cflag
        raw[3] = 0					# lflag
        raw[4] = raw[5] = eval("termios.B" + `speed`)
        termios.tcsetattr(ttyfp.fileno(), termios.TCSANOW, raw)

        i = 0;
        while True:
            if i % len(lines) == 0:
                print "gpsfake: log cycle begins"
            time.sleep(cycle)
            if linedump:
                print legend % (i % len(lines) + 1)
            os.write(master_fd, lines[i % len(lines)])
            i += 1
finally:
    if spawn:
        os.kill(pid, signal.SIGTERM)
