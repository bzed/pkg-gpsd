#!/bin/sh

set -e

. /usr/share/debconf/confmodule

if [ -s /etc/default/gpsd ] ; then
    . /etc/default/gpsd
    if [ -n "$START_DAEMON" ] ; then
        db_set gpsd/start_daemon "$START_DAEMON"
    fi
    if [ -n "$DAEMON_OPTS" ] ; then
        if echo "$DAEMON_OPTS" | grep -q -- '-F'; then
            if [ -z "$GPSD_SOCKET" ]; then
                GPSD_SOCKET=$(echo "$DAEMON_OPTS" | sed 's,.*-F +\([^ ]+\) .*,\1,')
            fi    
            DAEMON_OPTS=$(echo "$DAEMON_OPTS" | sed 's,-F +[^ ]+,,')
        fi
        db_set gpsd/daemon_options "$DAEMON_OPTS"
    fi
    if [ -n "$DEVICES" ] ; then
        db_set gpsd/device "$DEVICES"
    fi
    if [ -n "$USBAUTO" ]; then
        db_set gpsd/autodetection "$USBAUTO"
    fi
    if [ -n "$GPSD_SOCKET" ]; then
        db_set gpsd/socket "$GPSD_SOCKET"
    fi
fi


db_input medium gpsd/start_daemon || true
db_go
db_get gpsd/start_daemon
startd="$RET"

db_capb backup

STATE=2
ERRORS=0
PRIORITY_BROKENCONFIG="low"
while [ "$startd" = "true" ]; do

    #bail out after too many errors
    if [ "$ERRORS" -gt 5 ]; then
        STATE=0
    fi

    case "$STATE" in
        0)
            # There is no way to go back from the
            # first question. Exit is the only sane way.
            exit 10
        ;;
        1)
            db_input medium gpsd/start_daemon || true           
        ;;
        2)
            db_input low gpsd/device || true
        ;;
        3)
            db_input low gpsd/socket || true
        ;;
        4)
            db_input $PRIORITY_BROKENCONFIG gpsd/daemon_options || true
        ;;
        5)
            db_get gpsd/daemon_options
            opts="$RET"

            if ! echo "$opts" | grep -q -- '-F'; then
                PRIORITY_BROKENCONFIG="high"
                db_input low gpsd/brokenconfig || true
                STATE=4
                ERRORS=$(($ERRORS + 1))
            fi
        ;;
        6)
            db_input low gpsd/autodetection || true
            db_get gpsd/autodetection
            autodet="$RET"
            if [ "$autodet" = "true" ]; then
                db_get gpsd/socket
                socket="$RET"
                if [ -z "$socket" ]; then
                    db_set gpsd/socket "/var/run/gpsd.sock"
                fi
            fi
        ;;
        *)
            break
        ;;
    esac


    OLDSTATE="$STATE"
    if db_go; then
        STATE=$(($STATE + 1))
    else
        STATE=$(($STATE - 1))
    fi

    if [ $OLDSTATE -eq 1 ]; then
        db_get gpsd/start_daemon
        startd="$RET"
    fi

done


