From 9d7dc31b595b91aeb258faca459909b0b5b7965e Mon Sep 17 00:00:00 2001
From: "Eric S. Raymond" <esr@thyrsus.com>
Date: Wed, 9 May 2012 22:51:01 -0400
Subject: [PATCH] More Coverity-spawned fixes. All regression tests pass.

---
 driver_ubx.c |    2 +-
 gpsdecode.c  |    5 +++--
 net_ntrip.c  |   18 ++++++++++++------
 3 files changed, 16 insertions(+), 9 deletions(-)

--- a/driver_ubx.c
+++ b/driver_ubx.c
@@ -714,7 +714,7 @@ static bool ubx_speed(struct gps_device_
 	usart_mode |= 0x2000;	/* zero value means 1 stop bit */
     putle32(buf, 4, usart_mode);
     putle32(buf, 8, speed);
-    (void)ubx_write(session, 0x06, 0x00, &buf[6], 20);	/* send back with all other settings intact */
+    (void)ubx_write(session, 0x06, 0x00, buf, sizeof(buf));	/* send back with all other settings intact */
     /*@ -charint +usedef +compdef */
     return true;
 }
--- a/gpsdecode.c
+++ b/gpsdecode.c
@@ -428,12 +428,13 @@ static void decode(FILE *fpin, FILE*fpou
 		(void)fputs("\n", fpout);
 	    } 
 #ifdef SOCKET_EXPORT_ENABLE
-	    else
+	    else {
 		json_data_report(changed, 
 				 &session, &policy, 
 				 buf, sizeof(buf));
+		(void)fputs(buf, fpout);
+	    }
 #endif /* SOCKET_EXPORT_ENABLE */
-	    (void)fputs(buf, fpout);	
 #ifdef AIVDM_ENABLE
 	} else if (session.packet.type == AIVDM_PACKET) {
 	    if ((changed & AIS_SET)!=0) {
--- a/net_ntrip.c
+++ b/net_ntrip.c
@@ -494,12 +494,18 @@ int ntrip_open(struct gps_device_t *devi
 		(void)strlcpy(device->ntrip.stream.credentials, 
 			      auth, 
 			      sizeof(device->ntrip.stream.credentials));
-	    (void)strlcpy(device->ntrip.stream.url, 
-		    url, 
-		    sizeof(device->ntrip.stream.url));
-	    (void)strlcpy(device->ntrip.stream.port, 
-		    port, 
-		    sizeof(device->ntrip.stream.port));
+	    /* 
+	     * Semantically url and port ought to be non-NULL by now,
+	     * but just in case...this code appeases Coverity.
+	     */
+	    if (url != NULL)
+		(void)strlcpy(device->ntrip.stream.url, 
+			      url, 
+			      sizeof(device->ntrip.stream.url));
+	    if (port != NULL)
+		(void)strlcpy(device->ntrip.stream.port, 
+			      port, 
+			      sizeof(device->ntrip.stream.port));
 
 	    ret = ntrip_stream_req_probe(&device->ntrip.stream);
 	    if (ret == -1) {
