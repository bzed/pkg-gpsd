From 7e08bb2f93082fe0eba02dbc52b5692c49682279 Mon Sep 17 00:00:00 2001
From: "Eric S. Raymond" <esr@thyrsus.com>
Date: Thu, 10 May 2012 16:43:18 -0400
Subject: [PATCH] Plug a socket leak. This is Coverity defect #11.

---
 gpsd.c |    3 +++
 1 file changed, 3 insertions(+)

diff --git a/gpsd.c b/gpsd.c
index 7f977dd..142b5ff 100644
--- a/gpsd.c
+++ b/gpsd.c
@@ -451,6 +451,7 @@ static int passivesock_af(int af, char *service, char *tcp_or_udp, int qlen)
     if (setsockopt(s, SOL_SOCKET, SO_REUSEADDR, (char *)&one,
 		   (int)sizeof(one)) == -1) {
 	gpsd_report(LOG_ERROR, "Error: SETSOCKOPT SO_REUSEADDR\n");
+	(void)close(s);
 	return -1;
     }
     if (bind(s, &sat.sa, sin_len) < 0) {
@@ -459,10 +460,12 @@ static int passivesock_af(int af, char *service, char *tcp_or_udp, int qlen)
 	if (errno == EADDRINUSE) {
 	    gpsd_report(LOG_ERROR, "maybe gpsd is already running!\n");
 	}
+	(void)close(s);
 	return -1;
     }
     if (type == SOCK_STREAM && listen(s, qlen) == -1) {
 	gpsd_report(LOG_ERROR, "can't listen on port %s\n", service);
+	(void)close(s);
 	return -1;
     }
 
-- 
1.7.10

