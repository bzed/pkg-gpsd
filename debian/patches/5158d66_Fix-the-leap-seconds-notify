From 5158d66b981a78213af3639084592c9233d857da Mon Sep 17 00:00:00 2001
From: Michael Tatarinov <kukabu@gmail.com>
Date: Tue, 26 Jun 2012 13:45:58 +0400
Subject: [PATCH] Fix the leap seconds notify.

Signed-off-by: Eric S. Raymond <esr@thyrsus.com>
---
 gpsd.h-tail |    5 +++++
 subframe.c  |    6 +++++-
 timebase.c  |    3 ---
 3 files changed, 10 insertions(+), 4 deletions(-)

--- a/gpsd.h-tail
+++ b/gpsd.h-tail
@@ -95,6 +95,11 @@ enum isgpsstat_t {
  */
 #define GPS_EPOCH	315964800	/* 6 Jan 1981 00:00:00 UTC */
 
+/* time constant */
+#define SECS_PER_DAY	(60*60*24)		/* seconds per day */
+#define SECS_PER_WEEK	(7*SECS_PER_DAY)	/* seconds per week */
+#define GPS_ROLLOVER	(1024*SECS_PER_WEEK)	/* rollover period */
+
 struct gps_packet_t {
     /* packet-getter internals */
     int	type;
--- a/subframe.c
+++ b/subframe.c
@@ -722,8 +722,12 @@ gps_mask_t gpsd_interpret_subframe(struc
 			subp->sub4_18.DN, subp->sub4_18.lsf);
 
 #ifdef NTPSHM_ENABLE
+		/* IS-GPS-200 Revision E, paragraph 20.3.3.5.2.4 */
 		if ((subp->sub4_18.WNt == subp->sub4_18.WNlsf) &&
-		    (subp->sub4_18.DN == 1 )) {
+		    ((session->context->gps_week % 256) == (unsigned short)subp->sub4_18.WNlsf) &&
+		    /* notify the leap seconds correction in the end of current day */
+		    ((double)((subp->sub4_18.DN - 1) * SECS_PER_DAY) < session->context->gps_tow) &&
+		    ((double)(subp->sub4_18.DN * SECS_PER_DAY) > session->context->gps_tow)) {
 		   if ( subp->sub4_18.leap < subp->sub4_18.lsf )
 			session->context->leap_notify = LEAP_ADDSECOND;
 		   else if ( subp->sub4_18.leap > subp->sub4_18.lsf )
--- a/timebase.c
+++ b/timebase.c
@@ -84,9 +84,6 @@ BSD terms apply: see the file COPYING in
 #include "gpsd.h"
 #include "timebase.h"
 
-#define SECS_PER_WEEK	(60*60*24*7)	/* seconds per week */
-#define GPS_ROLLOVER	(1024*SECS_PER_WEEK)	/* rollover period */
-
 void gpsd_time_init(struct gps_context_t *context, time_t starttime)
 /* initialize the GPS context's time fields */
 {
